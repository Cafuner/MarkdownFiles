# 北京大学肖臻老师《区块链技术与应用》公开课



## 2 密码学原理

### 2.1哈希

密码学中的哈希函数cryptographic hash function的性质：

1. collision resistance：人为无法高效制造哈希碰撞。

    可以用于求消息的摘要（digest）。

    哈希函数的这个性质不是理论证明的， 而是实践经验。

2. hiding：哈希计算过程是不可逆的。x→H(x)容易计算，但H(x)→x不能高效计算。

    用处：digital commitment。

比特币中用到的哈希函数需要第三个性质：

3. puzzle friendly： 哈希算法的计算结果不可预测，要想结果在某个范围内，只能大量输入，大量计算。

比特币中使用的哈希函数：**SHA-256**。满足上述三个性质。



### 2.2签名

比特币的去中心化账户管理。开户就是创建公私钥对。

公钥就相当于账号，私钥就是密码。

只要有好的随机源，产生相同公私钥对的概率极低。



## 3.数据结构

### 3.1哈希指针

存储结构体的地址，同时还存储结构体的哈希值。

区块链与普通链表的区别之一：用哈希指针代替了普通指针。区块链的每个区块都包含了一个指向前一个区块的哈希指针。若要篡改中间的一个区块，到链尾的所有区块都需要修改。



### 3.2默克尔树Merkle Tree

与二叉树的区别之一：用哈希指针代替了普通的指针。

最下面的一层是数据块，其他的都是哈希指针。

每个区块的交易被组织成merkle tree。

每个区块分为：块头和块身。block header包含merkle tree的根哈希。block body包含具体的交易。

全节点：包含header和body。

轻节点：只有header。

**merkle proof**：轻节点在验证一个交易tx是否发生时，只有这个交易所属区块的头，其中有merkle根。首先计算hash(tx)，然后想全节点请求交易tx到merkle根的路径上的其他hash值。最后计算出merkle根，与区块头中的比对，若相同，则证明交易tx被写到了链上。

proof of membership: $\theta(log(n))$,

proof of non-membership:若不对数据排序$\theta(n)$，若排序$\theta(log(n))$

比特币不需要不存在证明，使用的是unsorted merkle tree。



## 4.共识协议

去中心化的货币：1.发行问题；2.交易的有效性。

每个交易分为输入和输入。

输入包括币的来源的哈希指针。

输出包括收款人的公钥。



block header：

+ version
+ 前一个区块头的哈希指针
+ merkle root hash
+ target
+ nonce

block body：

+ 交易链表transaction list

共识协议：最长链原则。



## 5.实现

### 5.1 UTXO

系统需要维护未花掉的交易输出的集合。

奖励机制：出块奖励和交易费。

每个发布的区块中有一个特殊的交易，铸币交易。该交易有一个coinbase域。该域的内容可以为任意信息，但会影响merkle root hash。因此，一个区块的4字节nonce不够用时，可以将其中铸币交易的coinbase的前若干个字节作为额外的nonce。

### 5.2 记账权

挖矿成功的概率服从伯努利分布，保证矿工夺取记账权的概率是根据算力公平分配的。



### 5.3 总量

$21w\times50+21w\times25+21w\times12.5+···=2100w$

### 5.4 comfirmation

为了避免double spending attack。当前交易的区块后产生了6个区块后，认为该链是不可回滚的。

但有的商家可以在交易上链之前就认为付款成功，因为许多诚实节点在面对两个冲突的交易时，只会承认第一个发生的交易，忽略第二个。



## 6.网络

P2P网络，所有节点平等。

消息传播采用flooding的方式。

系统维护一个等待上链的交易集合。

当一个节点侦测到一个广播的交易，它首先检查交易是否合法，然后检查自己的集合中有没有与该交易冲突的交易，最后将交易加入集合。当收到一个区块广播且合法时，将自己的待上链交易集合更新。

 











